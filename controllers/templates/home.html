<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Bienvenue !</title>
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
     <link href="https://use.fontawesome.com/releases/v5.0.7/css/all.css" rel="stylesheet">
    <style>
		/* Header et nav*/
        header {
            color: wheat;
            min-height: 300px;
            background-color: brown;
        }
        header h1{
            font-size: 100px;
            margin: 10px 30px;
        }
        a.nav-link {
            font-size: 50px;
            color: white;
        }

		a.nav-link:hover{
			background-color: black;
		}

		a.nav-link:active {
			color: wheat;
		}

        th{
            font-size: 40px;
        }

        td {
            font-size: 30px;
            min-width: 100px;
        }

		td[instruction]{
			min-width: 400px;
		}

        section {
			margin-top: 20px;
			border: black solid 1px;
		}

    </style>
</head>
<body class="container-fluid">
    <header class="row">
		<h1 class="col text-center">Liste des ingrédients</h1>
    </header>
    <nav class="row bg-dark text-white text-center">
        <div class="col-lg-4 col-sm-12 menu">
            <a class="nav-link" href="/">Recettes</a>
        </div>
        <div class="col-lg-4 col-sm-12 menu">
            <a class="nav-link" href="/ingredients">Ingrédients</a>
        </div>
        <div class="col-lg-4 col-sm-12 menu">
            <a class="nav-link" href="/nouvelleRecette">Ajout</a>
        </div>
    </nav>
    <main>
        <div class="col-1"></div>
        <div class="col-10">
            <h2>
                Liste des recettes
            </h2>
            <form class="row">
                <div class="col">
                    <div class="row">
                        <input id="searchRecipeByName" type="text" class="form-control" placeholder="Rechercher une recette">
                    </div>
                    <div class="row">
                        <select id="sources">
                            <option selected disabled>Filter par source</option>
                            <option value="0">Toutes</option>
                        </select>
                    </div>
                    <div class="row" id="categories">
                    </div>
                </div>
            </form>
            <div class="col">
                <ul id="listRecipes">
                </ul>
            </div>

        </div>
         <div class="col-1"></div>
    </main>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
            integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
            integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
            crossorigin="anonymous"></script>
    <script type="text/javascript" src="../static/js/script.js"></script>
    <script type="text/javascript">
        window.onload = function () {
            $.getJSON(port + "api/recipes", function(data) {
                $.each(data, function(key, val) {
                    let li = $("<li>")
                    li.attr("recette", val.id).attr("source", val.id_src)
                    li.append($("<a>").attr("href","/recette/"+val.id).html(val.name))
                    $("#listRecipes").append(li)
                    $.getJSON(port + "api/categories/recipe/" + val.id, function(data) {
                        $.each(data, function(key, val) {
                            li.append($("<div>").attr("hidden", "hidden").attr("category", val.id))
                        })
                    })
                    $.getJSON(port + "api/ingredients/recipe/" + val.id, function(data) {
                        $.each(data, function(key, val) {
                            li.append($("<div>").attr("hidden", "hidden").attr("ingredient", val.id_ingredient))
                        })
                    })
                    $.getJSON(port + "api/sources", function(data) {
                        $.each(data, function(key, val) {
                            $("#sources").append($("<option>").val(val.id).html(val.name))
                        })
                    })
                    $.getJSON(port + "api/categories", function(data) {
                        $.each(data, function(key, val) {
                            let label = $("<label>").attr("for", "category"+val.id).html(val.name)
                            let input = $("<input>").addClass("category")
                                                    .attr("id", "category"+val.id)
                                                    .attr("type", "checkbox").val(val.id)
                                                    .attr("onclick", "filterCategory()")
                                                    .html(val.name)
                            $("#categories").append(label).append(input)
                        })
                    })
                })
            })
        }

         $("#searchRecipeByName").keyup(function () {
            let tag = $("#searchRecipeByName").val().toLowerCase()
            $("li").filter(function () {
                $(this).toggle($(this).text().toLowerCase().indexOf(tag) > -1)
            })
        })

        $("#sources").change(function () {
            if ($("#sources").val() != 0){
                $("li").filter(function () {
                    $(this).toggle($(this).attr("source").toLowerCase().indexOf($("#sources").val()) > -1)
                })
            } else {
                $("li").filter(function () {
                    $(this).toggle($(this).attr("source").toLowerCase().indexOf($("#sources").val()) == -1)
                })
            }
        })

        let filterCategory = function(){
            let checked = []
            $("input.category").each(function () {
                if ($(this).is(':checked')){
                    checked.push(parseInt($(this).val()))
                }
            })

            if (checked.length == 0) {
                $("li").filter(function () {
                    $(this).toggle(true)
                })
            } else {
                $("li").each(function () {
                    let id_recipe = $(this).attr("recette")
                    let display = false
                    let categories = []
                    $(this).find("div[category]").each(function(){
                        categories.push(parseInt($(this).attr("category")))
                    })
                    categories.forEach(function (elem) {
                        if(checked.indexOf(elem) > -1){
                            display = true
                        }
                    })
                    $("li[recette=" + id_recipe + "]").toggle(display)
                })
            }
        }

    </script>
</body>
</html>